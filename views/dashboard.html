<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cadet's Compass ‚Äî Dashboard (Phase 2)</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../public/css/navbar.css">
  <style>
    :root{
      --bg:#0f2b1e;
      --panel:#efe9e2;
      --muted:#8c8c8c;
      --accent:#6b8a4c;
      --card:#ffffff22;
      --glass: rgba(255,255,255,0.06);
      --glass-2: rgba(255,255,255,0.12);
      --text:#f6f3ee;
      --rounded:16px;
      --max-width:1200px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;color:var(--text);}
    body{
      background: linear-gradient(180deg, rgba(10,12,14,0.75), rgba(0,0,0,0.55)),
                  url('background.jpg') center/cover no-repeat fixed;
      -webkit-font-smoothing: antialiased; 
      -moz-osx-font-smoothing: grayscale;
      padding: 0; /* moved page padding into .app so navbar sibling spacing works reliably */
    }

  /* keep the dashboard spacing inside the main .app container; reserve space for the fixed navbar using the --nav-height variable */
  .app{display:flex;gap:24px;max-width:1400px;margin:0 auto;align-items:flex-start;padding: calc(var(--nav-height,64px) + 24px) 24px 24px 24px;}

    .sidebar{
      width:260px;background:linear-gradient(180deg,#0e2a1f,#133a27);border-radius:14px;padding:22px;flex:0 0 260px;box-shadow:0 10px 28px rgba(0,0,0,0.5);
    }
    .brand{display:flex;gap:12px;align-items:center;margin-bottom:18px}
    .avatar{width:52px;height:52px;border-radius:50%;background:#567a55;display:flex;align-items:center;justify-content:center;font-weight:700}
    .brand h3{margin:0;font-size:16px}
    .brand p{margin:0;color:rgba(255,255,255,0.7);font-size:13px}
    .profile-btn{display:block;background:rgba(255,255,255,0.06);padding:10px;border-radius:10px;margin:14px 0;text-align:center;color:var(--text);text-decoration:none}
    .nav{margin-top:8px}
    .nav a{display:flex;gap:12px;align-items:center;padding:12px 14px;border-radius:12px;color:var(--text);text-decoration:none;margin-bottom:8px;cursor:pointer;transition:background .2s ease}
    .nav a:hover{background:rgba(255,255,255,0.08)}
    .nav a.active{background:rgba(255,255,255,0.14);box-shadow:inset 0 1px 0 rgba(255,255,255,0.06)}
    .nav svg{opacity:0.95}

    .main{flex:1}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
    .search{flex:1;margin-left:16px}
    .search input{width:100%;padding:14px 18px;border-radius:14px;border:1px solid rgba(0,0,0,0.08);background:#ffffff;color:#0b0b0b;font-weight:600;box-shadow:0 2px 10px rgba(0,0,0,0.12)}
    .logout-btn{margin-left:16px;background:#d9534f;color:#fff;border:0;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
    .logout-btn:hover{opacity:0.9}

    .grid{display:grid;grid-template-columns:1fr;gap:22px;margin-bottom:30px}
    .card{background:#f4f6f8;padding:26px 26px;border-radius:14px;color:#1f2328;box-shadow:0 10px 24px rgba(0,0,0,0.22), inset 0 1px 0 rgba(255,255,255,0.6)}

    .card h4{margin:0 0 12px 0}
    .date-item{display:flex;justify-content:space-between;align-items:center;padding:14px 0;border-bottom:1px solid rgba(0,0,0,0.06)}
    .date-item:last-child{border-bottom:0}
    .pill{padding:6px 12px;border-radius:999px;background:#e6d4a8;color:#2e2e2e;font-weight:800}

    .section-title{font-size:28px;font-weight:800;margin:6px 0 18px}
    .categories{display:flex;gap:18px;flex-wrap:wrap}
    .cat{min-width:170px;flex:0 0 170px;border-radius:14px;padding:28px 16px;background:var(--card);backdrop-filter:blur(6px);text-align:center;box-shadow:0 10px 25px rgba(5,5,5,0.35);cursor:pointer}
    .cat h5{margin:12px 0 0;font-size:15px;color:var(--text)}
    .cat .emoji{font-size:28px}

    .popular{display:flex;gap:16px;flex-wrap:wrap}
    .topic{width:170px;background:#ffffff;color:#171717;border-radius:14px;overflow:hidden;cursor:pointer;box-shadow:0 10px 22px rgba(0,0,0,0.18)}
    .topic .thumb{height:100px;background:url('/mnt/data/f49fd5dc-6783-40cf-86e5-a180880960c5.png') center/cover}
    .topic .meta{padding:12px}

  @media (max-width:1000px){.app{padding: calc(var(--nav-height,64px) + 12px) 12px 12px 12px}.grid{grid-template-columns:1fr}.sidebar{display:none}}
    @media (max-width:680px){.cat{flex:1 1 45%}.topic{width:48%}}
    .muted{color:var(--muted);font-weight:600}
  </style>
</head>
<body>
  <div id="navbar"></div>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <div class="avatar">CE</div>
        <div>
          <h3>CadetEducation</h3>
          <p>student</p>
        </div>
      </div>
      <a class="profile-btn" href="profile.html">View Profile</a>

      <nav class="nav">
        <a class="active" onclick="window.location.href='dashboard.html'">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M3 11.5L12 4l9 7.5V20a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1V11.5z" stroke="white" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg> Home
        </a>
        <a onclick="window.location.href='about.html'">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="8" r="3" stroke="white" stroke-width="1.2"/>
            <path d="M21 20v-2a4 4 0 0 0-4-4H7a4 4 0 0 0-4 4v2" stroke="white" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg> About
        </a>
        <a onclick="window.location.href='courses.html'">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <rect x="3" y="4" width="18" height="14" rx="2" stroke="white" stroke-width="1.2"/>
          </svg> Courses
        </a>
        <a onclick="window.location.href='mocktests.html'">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M11 5h2v6h-2zM5 3h14v4H5zM4 21h16v-2H4z" stroke="white" stroke-width="1"/></svg> Mock Tests
        </a>
        <a onclick="window.location.href='routemaps.html'">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M12 2v20" stroke="white" stroke-width="1.2"/>
            <circle cx="12" cy="12" r="3" stroke="white" stroke-width="1.2"/>
          </svg> Route Maps
        </a>
        <a onclick="window.location.href='ai.html'"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 22s8-4 8-10-3.582-8-8-8-8 3.582-8 8 8 10 8 10z" stroke="white" stroke-width="1.2"/></svg> AI Assistant</a>
        <a onclick="window.location.href='important-dates.html'"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 10h-6V4l-2-2-2 2v6H3v10h18V10z" stroke="white" stroke-width="1.2"/></svg> Important Dates & Notifications</a>
        <a onclick="window.location.href='contact.html'"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 8v13H3V8" stroke="white" stroke-width="1.2"/><path d="M7 8V6a5 5 0 0 1 10 0v2" stroke="white" stroke-width="1.2"/></svg> Contact Us</a>
      </nav>
    </aside>

    <main class="main">
      <div class="topbar">
        <h1 style="margin:0;font-size:22px;font-weight:800">Cadet's Compass</h1>
        <div class="search" style="max-width:640px">
          <input placeholder="Search mock tests, syllabus, topics or route maps..." />
        </div>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>

      <section>
        <div class="card">
          <h4>Important Dates & Notifications</h4>
          <div style="margin-bottom:20px;padding-bottom:16px;border-bottom:2px solid rgba(0,0,0,0.1)">
            <h5 style="margin:0 0 12px 0;font-size:16px;font-weight:700;color:#1f2328">üìÖ Important Dates</h5>
            <div class="date-item"><div><strong>NDA (I) 2025</strong><div class="muted">Notification: 18 Dec 2024 | Exam: 13 Apr 2025</div></div><div class="pill" style="background:#4b7e3a;color:white">Upcoming</div></div>
            <div class="date-item"><div><strong>CDS (I) 2025</strong><div class="muted">Notification: 8 Sep 2024 | Exam: 1 Dec 2024</div></div><div class="pill">8th Sep 24</div></div>
            <div class="date-item"><div><strong>AFCAT (I) 2025</strong><div class="muted">Notification: 1 Dec 2024 | Exam: 22-23 Feb 2025</div></div><div class="pill" style="background:#4b7e3a;color:white">Upcoming</div></div>
            <div class="date-item"><div><strong>Agniveer 2025</strong><div class="muted">Notification: 12 Mar 2025 | Exam: 30 Jun-10 Jul 2025</div></div><div class="pill">12th Mar 25</div></div>
            <div class="date-item"><div><strong>Territorial Army (O.E) 2025</strong><div class="muted">Notification: May 2025 | Exam: 20 Jul 2025</div></div><div class="pill">May 2025</div></div>
            <div class="date-item"><div><strong>CDS (II) 2025</strong><div class="muted">Notification: Jun 2025 | Exam: Sep 2025</div></div><div class="pill">Jun 2025</div></div>
          </div>
          <div>
            <h5 style="margin:0 0 12px 0;font-size:16px;font-weight:700;color:#1f2328">üîî Notifications</h5>
            <div class="date-item"><div><strong>AFCAT Notification</strong><div class="muted">New vacancies announced</div></div><div class="pill">2nd Jul 24</div></div>
            <div class="date-item"><div><strong>Agniveer Recruitment</strong><div class="muted">Apply now - Registration open</div></div><div class="pill">15th Jul 24</div></div>
            <div class="date-item"><div><strong>SSB Interview Tips</strong><div class="muted">New guide available</div></div><div class="pill" style="background:#4b7e3a;color:white">New</div></div>
          </div>
        </div>
      </section>

      <section>
        <div class="section-title">Top Categories</div>
        <div class="categories">
          <div class="cat" style="background:linear-gradient(180deg,#597a49,#4a6b3e);" onclick="window.location.href='nda.html'">
            <div class="emoji">‚öî</div>
            <h5>NDA<br><small style="font-weight:600;opacity:0.9">(National Defence Academy)</small></h5>
          </div>
          <div class="cat" style="background:linear-gradient(180deg,#275a84,#2a5f88);" onclick="window.location.href='afcat.html'">
            <div class="emoji">ü¶Ö</div>
            <h5>AFCAT</h5>
          </div>
          <div class="cat" style="background:linear-gradient(180deg,#c7b79f,#bfae96);color:#fff;" onclick="window.location.href='fitness.html'">
            <div class="emoji">‚úà</div>
            <h5>Indian Fitness Drills</h5>
          </div>
          <div class="cat" style="background:linear-gradient(180deg,#2f6e8d,#2a5f88);" onclick="window.location.href='agniveer.html'">
            <div class="emoji">‚öì</div>
            <h5>Agniveer</h5>
          </div>
          <div class="cat" style="background:linear-gradient(180deg,#2f5238,#293e2b);" onclick="window.location.href='ta.html'">
            <div class="emoji">üõ°</div>
            <h5>Territorial Army</h5>
          </div>
          <div class="cat" style="background:linear-gradient(180deg,#8b4513,#6b3410);" onclick="window.location.href='cds.html'">
            <div class="emoji">üéñ</div>
            <h5>CDS<br><small style="font-weight:600;opacity:0.9">(Combined Defence Services)</small></h5>
          </div>
        </div>
      </section>

      <section style="margin-top:26px">
  <div class="section-title">Popular Topics</div>
  <div class="categories">
    <div class="cat" style="background:linear-gradient(180deg,#597a49,#4a6b3e);" onclick="window.location.href='ssb.html'">
      <div class="emoji">‚öî</div>
      <h5>SSB Interview Prep</h5>
    </div>
    <div class="cat" style="background:linear-gradient(180deg,#2f6e8d,#2a5f88);" onclick="window.location.href='fitness.html'">
      <div class="emoji">üí™</div>
      <h5>Physical Fitness Drills</h5>
    </div>
    <div class="cat" style="background:linear-gradient(180deg,#c7b79f,#bfae96);color:#fff;" onclick="window.location.href='history.html'">
      <div class="emoji">üìú</div>
      <h5>Physical History & Aptitude</h5>
    </div>
    <div class="cat" style="background:linear-gradient(180deg,#275a84,#2a5f88);" onclick="window.location.href='currentaffairs.html'">
      <div class="emoji">üì∞</div>
      <h5>Current Affairs - Defence</h5>
    </div>
    <div class="cat" style="background:linear-gradient(180deg,#2f5238,#293e2b);" onclick="window.location.href='civics.html'">
      <div class="emoji">üèõ</div>
      <h5>Civics - Defence Focus</h5>
    </div>
  </div>
</section>

    </main>
  </div>

  <script>
    // Search bar functionality
    const searchMap = {
      'nda': 'nda.html',
      'afcat': 'afcat.html',
      'cds': 'cds.html',
      'fitness': 'fitness.html',
      'agniveer': 'agniveer.html',
      'ta': 'ta.html',
      'ssb': 'ssb.html',
      'history': 'history.html',
      'current affairs': 'currentaffairs.html',
      'civics': 'civics.html',
      'mock tests': 'mocktests.html',
      'routemaps': 'routemaps.html'
    };
    const searchInput = document.querySelector('.search input');
    searchInput.addEventListener('keydown', function(event) {
      if(event.key === 'Enter') {
        const query = searchInput.value.trim().toLowerCase();
        if(searchMap[query]) {
          window.location.href = searchMap[query];
        } else {
          alert('No page found for: ' + query);
        }
      }
    });
  </script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>
  <script>
    // Initialize Firebase (same config as login)
    const firebaseConfig = {
      apiKey: "AIzaSyBZKbxJNlMZHEAeRoK7eAIkeV7Nr4U5AMk",
      authDomain: "cadetcompass-4fdfb.firebaseapp.com",
      projectId: "cadetcompass-4fdfb",
      storageBucket: "cadetcompass-4fdfb.firebasestorage.app",
      messagingSenderId: "402156270617",
      appId: "1:402156270617:web:61528de7fd28966869a688",
      measurementId: "G-MVS8V0DXFH"
    };
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.firestore();

    async function logout(){
      try{
        await auth.signOut();
        localStorage.removeItem('cc_idToken');
        window.location.href = 'login.html';
      }catch(err){
        console.error(err);
        alert('Logout failed. Please try again.');
      }
    }
    
    // Session verification and data fetch
    const API_BASE = 'http://127.0.0.1:4000';
    (async function initDashboard(){
      const token = localStorage.getItem('cc_idToken');
      if(!token){
        // If reached here without token, try to get from Firebase directly
        const user = auth.currentUser;
        if (user) {
          const fresh = await user.getIdToken();
          localStorage.setItem('cc_idToken', fresh);
        } else {
          return window.location.href = 'login.html';
        }
      }
      const idToken = localStorage.getItem('cc_idToken');
      
      // Function to update user display
      function updateUserDisplay(name, email) {
        const displayName = name || (email ? email.split('@')[0] : null) || 'User';
        const initials = displayName.split(' ').map(w => w[0]).join('').slice(0,2).toUpperCase();
        
        const avatar = document.querySelector('.avatar');
        if (avatar) avatar.textContent = initials;
        
        const brandName = document.querySelector('.brand h3');
        if (brandName) brandName.textContent = displayName;
      }
      
      // Listen for auth state changes to always keep user info updated
      auth.onAuthStateChanged((user) => {
        if (user) {
          // Try API first, but use Firebase as fallback
          const idToken = localStorage.getItem('cc_idToken');
          if (idToken) {
            fetch(`${API_BASE}/api/auth/me`, { headers: { Authorization: `Bearer ${idToken}` } })
              .then(res => res.ok ? res.json() : null)
              .then(me => {
                if (me && me.name) {
                  updateUserDisplay(me.name, me.email);
                } else {
                  updateUserDisplay(user.displayName, user.email);
                }
              })
              .catch(() => {
                updateUserDisplay(user.displayName, user.email);
              });
          } else {
            updateUserDisplay(user.displayName, user.email);
          }
        }
      });
      
      // Initial update attempt
      try {
        const meRes = await fetch(`${API_BASE}/api/auth/me`, { headers: { Authorization: `Bearer ${idToken}` } });
        if (meRes.ok) {
          const me = await meRes.json();
          updateUserDisplay(me.name, me.email);
        } else {
          // If API fails, try Firebase auth as fallback
          const user = auth.currentUser;
          if (user) {
            updateUserDisplay(user.displayName, user.email);
          }
        }
      } catch(e) {
        console.warn('Could not verify session with backend, using Firebase auth');
        // Fallback to Firebase auth
        const user = auth.currentUser;
        if (user) {
          updateUserDisplay(user.displayName, user.email);
        }
      }

      // Fetch mock tests (protected)
      try {
        const res = await fetch(`${API_BASE}/api/mocktests`, { headers: { Authorization: `Bearer ${idToken}` } });
        if (res.ok) {
          const data = await res.json();
          // Render a simple list under Notifications card
          const card = document.querySelectorAll('.card')[1];
          if (card && data.items?.length) {
            const wrap = document.createElement('div');
            wrap.innerHTML = `<h4 style="margin-top:18px">Mock Tests</h4>` +
              data.items.map(i => `<div class="date-item"><div><strong>${i.title}</strong><div class="muted">Duration ${i.durationMin} min</div></div></div>`).join('');
            card.appendChild(wrap);
          }
        }
      } catch(e) {
        console.warn('Mocktests fetch failed (backend down?). Trying Firestore.');
        try{
          const snap = await db.collection('mockTests').where('isActive','==', true).get();
          const items = [];
          snap.forEach(doc => items.push(doc.data()));
          if (items.length) {
            const card = document.querySelectorAll('.card')[1];
            if (card) {
              const wrap = document.createElement('div');
              wrap.innerHTML = `<h4 style="margin-top:18px">Mock Tests</h4>` +
                items.map(i => `<div class=\"date-item\"><div><strong>${i.title}</strong><div class=\"muted\">Duration ${i.durationMin || ''} min</div></div></div>`).join('');
              card.appendChild(wrap);
            }
          }
        }catch(err){
          console.warn('Firestore fallback failed');
        }
      }
    })();
  </script>
  <script src="../public/js/navbar.js"></script>
</body>
</html>

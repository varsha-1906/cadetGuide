<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Connect Google Calendar</title>
  <style>
    body{font-family:Inter,system-ui;background:linear-gradient(180deg,#1c2a1c,#3d5f3f);color:#fff;padding:24px}
    .card{background:rgba(255,255,255,0.06);padding:18px;border-radius:10px;max-width:720px}
    input,select{width:100%;padding:8px;margin-top:8px;border-radius:6px;border:none;background:rgba(255,255,255,0.04);color:#fff}
    button{margin-top:12px;padding:10px 14px;border-radius:8px;border:0;background:#6b8a4c;color:#fff;font-weight:700;cursor:pointer}
    pre{background:#000;padding:10px;border-radius:6px}
  </style>
</head>
<body>
  <div class="card">
    <h2>Google Calendar — Connect & Create</h2>
    <p><a href="/auth"><button>Connect to Google Calendar</button></a></p>
    <p id="status">Status: checking...</p>

    <hr>
    <h3>Create event (manual test)</h3>
    <label>Title<input id="title" value="Cadet's Compass: Mock Test"></label>
    <label>Description<textarea id="desc">Mock test reminder</textarea></label>
    <label>Start (YYYY-MM-DDTHH:MM) <input id="start" placeholder="2025-10-05T15:30"></label>
    <label>Duration (mins) <input id="duration" type="number" value="60"></label>
    <label>Timezone <select id="tz"><option>Asia/Kolkata</option><option>UTC</option></select></label>
    <button id="createBtn">Add to Calendar</button>
    <p id="createStatus"></p>

    <hr>
    <h4>Programmatic example (when a website notification occurs)</h4>
    <pre>fetch('/create-event', {
  method:'POST',
  headers:{'Content-Type':'application/json'},
  body: JSON.stringify({
    summary: 'Notification Title',
    description: 'Details...',
    start: '2025-10-05T15:30:00',
    end: '2025-10-05T16:30:00',
    timezone: 'Asia/Kolkata',
    reminders: [{method:'popup',minutes:15}]
  })
})</pre>
  </div>

<script>
async function checkStatus(){
  try{
    const res = await fetch('/calendar-status');
    const data = await res.json();
    document.getElementById('status').innerText = 'Status: ' + (data.connected ? 'Connected' : 'Not connected');
  }catch(e){
    document.getElementById('status').innerText = 'Status: error';
  }
}
checkStatus();

document.getElementById('createBtn').addEventListener('click', async () => {
  const title = document.getElementById('title').value;
  const desc = document.getElementById('desc').value;
  const startRaw = document.getElementById('start').value;
  const duration = parseInt(document.getElementById('duration').value || '60', 10);
  const tz = document.getElementById('tz').value;
  if(!startRaw){ document.getElementById('createStatus').innerText = 'Enter start date/time'; return; }
  const startDt = new Date(startRaw);
  const endDt = new Date(startDt.getTime() + duration*60000);

  document.getElementById('createStatus').innerText = 'Creating...';

  try{
    const res = await fetch('/create-event', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        summary: title,
        description: desc,
        start: startDt.toISOString(),
        end: endDt.toISOString(),
        timezone: tz,
        reminders: [{method:'popup', minutes:30}, {method:'email', minutes:60}]
      })
    });
    const data = await res.json();
    if(data && data.success){
      document.getElementById('createStatus').innerHTML = 'Created ✓ <a href="'+(data.event.htmlLink||'#')+'" target="_blank">Open event</a>';
    } else {
      document.getElementById('createStatus').innerText = JSON.stringify(data);
    }
  }catch(e){
    document.getElementById('createStatus').innerText = 'Error: ' + e.message;
  }
});
</script>
</body>
</html>
